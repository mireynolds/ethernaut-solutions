#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$REPO_ROOT"

DOCKER_HOST="host.docker.internal:host-gateway"
FOUNDRY_TEST_IMAGE="foundry-build-test"
ETHERNAUT_IMAGE="ethernaut-run"
ETHERNAUT_CONTAINER="ethernaut"

DOCKER_FLAGS=(
  --cap-drop=ALL
  --security-opt="no-new-privileges=true"
  --pids-limit=512
  --memory=2g
  --cpus=2
)


usage() {
  cat <<'EOF'
Usage: 
  ./ethernaut <command>

Commands:
  launch                Runs Ethernaut app and RPC in a local docker container.
  stop                  Stops the Ethernaut app and RPC (if running).
  logs                  Follow logs from the Ethernaut app and RPC.
  test                  Test the Ethernaut solutions by building a docker image.
  forge_fmt             Format tracked Solidity files using forge fmt in a docker container.
  forge_debug_level 13  Runs the level13 test with the forge debugger in a docker container.
  ecdsa                 Builds a docker image calculating ecdsa artifacts for levels 35 and 37.
  help                  Show this help.

EOF
}

build_ethernaut_image() {
  docker build -f "$REPO_ROOT/docker/$ETHERNAUT_IMAGE.Dockerfile" \
    -t "$ETHERNAUT_IMAGE" .
}

build_foundry_test_image() {
  docker build -f "$REPO_ROOT/docker/$FOUNDRY_TEST_IMAGE.Dockerfile" \
    --add-host "$DOCKER_HOST" \
    -t "$FOUNDRY_TEST_IMAGE" .
}

wait_for_addresses_log() {
  local src="/app/client/src/gamedata/deploy.local.json"
  local dst="$REPO_ROOT/addresses/addresses.log"
  local timeout="${2:-300}"
  local start now

  mkdir -p "$(dirname "$dst")"
  start="$(date +%s)"

  while :; do
    # File exists inside container, copy and return success
    if docker exec "$ETHERNAUT_CONTAINER" test -f "$src" 2>/dev/null; then
      docker cp "$ETHERNAUT_CONTAINER:$src" "$dst"
      return 0
    fi

    # Container is no longer running, return fail
    if ! docker inspect -f '{{.State.Running}}' "$ETHERNAUT_CONTAINER" 2>/dev/null | grep -q true; then
      echo "Container exited before addresses file was created" >&2
      return 1
    fi

    # Timeout
    now="$(date +%s)"
    if (( now - start > timeout )); then
      echo "Timed out waiting for addresses log" >&2
      return 1
    fi

    sleep 1
  done
}


launch() {
  build_ethernaut_image

  docker rm -f "$ETHERNAUT_CONTAINER" >/dev/null 2>&1 || true

  docker run -d \
    --name "$ETHERNAUT_CONTAINER" \
    -p 127.0.0.1:3000:3000 \
    -p 127.0.0.1:8545:8545 \
    "${DOCKER_FLAGS[@]}" \
    "$ETHERNAUT_IMAGE"
  
  wait_for_addresses_log "$ETHERNAUT_CONTAINER"
}

stop() {
  docker stop "$ETHERNAUT_CONTAINER" >/dev/null 2>&1 || true
}

logs() {
  docker logs -f "$ETHERNAUT_CONTAINER"
}

test() {
  build_foundry_test_image
}

forge_fmt() {
  docker run --rm \
    --network=none \
    "${DOCKER_FLAGS[@]}" \
    -u "$(id -u):$(id -g)" \
    -v "$REPO_ROOT":/work:ro \
    -v "$REPO_ROOT/test":/work/test:rw \
    -w /work \
    --entrypoint bash \
    ghcr.io/foundry-rs/foundry:latest \
    -c 'git ls-files -z -- "*.sol" | xargs -0 -r forge fmt'
}

forge_debug_level() {
  local level="$1"

  docker image inspect "$FOUNDRY_TEST_IMAGE" >/dev/null 2>&1 || build_foundry_test_image

  docker run --rm \
    -it \
    --add-host "$DOCKER_HOST" \
    --entrypoint /bin/bash \
    "${DOCKER_FLAGS[@]}" \
    "$FOUNDRY_TEST_IMAGE" \
    -c "forge test --debug --match-test testLevel${level} --fork-url http://host.docker.internal:8545"
}

ecdsa() {
    docker build --no-cache \
    --progress=plain \
    -f "$REPO_ROOT/docker/ecdsa-build-test.Dockerfile" \
    -t ecdsa ./ecdsa
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  launch) launch ;;
  stop) stop ;;
  logs) logs ;;
  test) test ;;
  forge_fmt) forge_fmt ;;
  forge_debug_level) forge_debug_level "$1" ;;
  ecdsa) ecdsa ;;
  help|-h|--help) usage ;;
  *)
    echo "Unknown command: $cmd" >&2
    echo >&2
    usage >&2
    exit 2
    ;;
esac
