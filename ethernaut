#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$REPO_ROOT"

DOCKER_HOST="host.docker.internal:host-gateway"
FOUNDRY_TEST_IMAGE="foundry-build-test"
ETHERNAUT_IMAGE="ethernaut-run"
ETHERNAUT_CONTAINER="ethernaut"

usage() {
  cat <<'EOF'
Usage: 
  PATH="$PWD:$PATH"
  ethernaut <command>

Commands:
  launch                Runs Ethernaut app and RPC in a local docker container.
  stop                  Stops the Ethernaut app and RPC (if running).
  logs                  Follow logs from the Ethernaut app and RPC.
  test                  Test the Ethernaut solutions by building a docker image.
  forge_fmt             Format tracked Solidity files using forge fmt in a docker container.
  forge_debug_level 13  Runs the level13 test with the forge debugger in a docker container.
  level35_a11ce         Builds a docker image calculating which logs a hash and signature pair for Alice.
  help                  Show this help.

EOF
}

build_ethernaut_image() {
  docker build -f "$REPO_ROOT/docker/$ETHERNAUT_IMAGE.Dockerfile" \
    -t "$ETHERNAUT_IMAGE" .
}

build_foundry_test_image() {
  docker build -f "$REPO_ROOT/docker/$FOUNDRY_TEST_IMAGE.Dockerfile" \
    --network host \
    --add-host "$DOCKER_HOST" \
    -t "$FOUNDRY_TEST_IMAGE" .
}

launch() {
  build_ethernaut_image

  docker rm -f "$ETHERNAUT_CONTAINER" >/dev/null 2>&1 || true

  docker run -d \
    --name "$ETHERNAUT_CONTAINER" \
    -p 3000:3000 \
    -p 8545:8545 \
    -v "$REPO_ROOT/addresses":/addresses \
    "$ETHERNAUT_IMAGE"
}

stop() {
  docker stop "$ETHERNAUT_CONTAINER" >/dev/null 2>&1 || true
}

logs() {
  docker logs -f "$ETHERNAUT_CONTAINER"
}

test() {
  build_foundry_test_image
}

forge_fmt() {
  docker run --rm \
    -u "$(id -u):$(id -g)" \
    -v "$REPO_ROOT":/work \
    -w /work \
    --entrypoint bash \
    ghcr.io/foundry-rs/foundry:latest \
    -lc 'git ls-files -z -- "*.sol" | xargs -0 -r forge fmt'
}

forge_debug_level() {
  local level="$1"

  docker image inspect "$FOUNDRY_TEST_IMAGE" >/dev/null 2>&1 || build_foundry_test_image

  docker run --rm \
    -it \
    --add-host "$DOCKER_HOST" \
    --entrypoint /bin/bash "$FOUNDRY_TEST_IMAGE" \
    -lc "forge test --debug --match-test testLevel${level} --fork-url http://host.docker.internal:8545"
}

level35_a11ce() {
    docker build --no-cache \
    --progress=plain \
    -f "$REPO_ROOT/docker/cargo-build-test.Dockerfile" \
    -t level35 ./level35
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  launch) launch ;;
  stop) stop ;;
  logs) logs ;;
  test) test ;;
  forge_fmt) forge_fmt ;;
  forge_debug_level) forge_debug_level "$1" ;;
  level35_a11ce) level35_a11ce ;;
  help|-h|--help) usage ;;
  *)
    echo "Unknown command: $cmd" >&2
    echo >&2
    usage >&2
    exit 2
    ;;
esac
